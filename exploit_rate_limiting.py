import requests
import time
import os
import json

# Create a session to manage cookies
session = requests.Session()

# Define the first URL
first_url = "https://app.danlon.dk/app/oauth2/login?returnURL=/app/medarbejder/generelt/NY?u%3D1752663549968"

# Headers for the first request
headers = {
    "Accept-Language": "en-US,en;q=0.9",
    "Upgrade-Insecure-Requests": "1",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.70 Safari/537.36",
    "Accept": "text/html,Rapplication/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
    "Sec-Fetch-Site": "none",
    "Sec-Fetch-Mode": "navigate",
    "Sec-Fetch-User": "?1",
    "Sec-Fetch-Dest": "document",
    "Sec-Ch-Ua": '"Not?A_Brand";v="99", "Chromium";v="130"',
    "Sec-Ch-Ua-Mobile": "?0",
    "Sec-Ch-Ua-Platform": '"Linux"',
    "Accept-Encoding": "gzip, deflate, br",
    "Priority": "u=0, i",
    "Cookie": "SERVERID=8d7792f5dd722416; JSESSIONID=DFFA6FC668E6AEC1C2E2CABEC890CD2D"
}

# Send the first GET request without following redirects
response = session.get(first_url, headers=headers, allow_redirects=False)

# Extract the new JSESSIONID from the response cookies
new_jsessionid = session.cookies.get("JSESSIONID")
print(f"New JSESSIONID: {new_jsessionid}")

# Read CPR numbers from numbers_clean.txt
with open("numbers_clean.txt", "r") as f:
    cpr_numbers = [line.strip() for line in f]

# Create a directory for responses if it doesn't exist
if not os.path.exists("responses"):
    os.makedirs("responses")

# Headers for the second request
headers2 = {
    "Sec-Ch-Ua-Platform": '"Linux"',
    "X-Requested-With": "XMLHttpRequest",
    "Accept-Language": "en-US,en;q=0.9",
    "Accept": "application/json, text/javascript, */*; q=0.01",
    "Sec-Ch-Ua": '"Not?A_Brand";v="99",
    "Chromium";v="130"',
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.70 Safari/      537.36",
    "Sec-Ch-Ua-Mobile": "?0",
    "Sec-Fetch-Site": "same-origin",
    "Sec-Fetch-Mode": "cors",
    "Sec-Fetch-Dest": "empty",
    "Referer": "https://app.danlon.dk/app/medarbejder/generelt/NY?u=1752663882046",
    "Accept-Encoding": "gzip, deflate, br",
    "Priority": "u=1, i"
}

# Process each CPR number
for cpr_number in cpr_numbers:
    timestamp = int(time.time() * 1000)
    url = f"https://app.danlon.dk/app/rest/cpropslag?cprnummer={cpr_number}&_={timestamp}"
    
    # Send the GET request with the new JSESSIONID
    response = session.get(url, headers=headers2)
    
    if response.status_code == 200:
        data = response.json()
        # Save the JSON response to a file
        with open(f"responses/{cpr_number}.json", "w") as f:
            json.dump(data, f)
        print(f"Saved response for CPR {cpr_number}")
    else:
        print(f"Error for CPR {cpr_number}: {response.status_code}")
